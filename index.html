<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Taiwan Weather Pokedex</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Roboto+Mono:wght@400;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --pokedex-red: #DC0A2D;
            --pokedex-dark-red: #8B0000;
            --screen-bg: #232323;
            --screen-text: #E0E0E0;
            --btn-blue: #28AAFD;
            --btn-green: #51AE5F;
            --btn-yellow: #FFCB05;
            --led-blue: #3B4CCA;
            --case-padding: 15px;
        }

        * {
            box-sizing: border-box;
            user-select: none;
            /* Prevent text selection */
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: #2a2a2a;
            font-family: 'Roboto Mono', monospace;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: var(--screen-text);
            overflow: hidden;
        }

        /* --- Pokedex Outer Case --- */
        .pokedex-case {
            width: 100%;
            max-width: 480px;
            height: 100vh;
            /* Full screen on mobile */
            background-color: var(--pokedex-red);
            display: flex;
            flex-direction: column;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            border-radius: 0;
            font-family: 'Roboto Mono', monospace;
        }

        @media (min-width: 481px) {
            .pokedex-case {
                height: 90vh;
                border-radius: 15px;
                border-bottom-right-radius: 50px;
                border: 3px solid #5d0000;
            }
        }

        /* --- Top Sensor Bar --- */
        .top-bar {
            height: 90px;
            background-color: var(--pokedex-red);
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* Lens left, Buttons right */
            padding: 0 20px;
            box-shadow: inset 0 -5px 10px rgba(0, 0, 0, 0.2);
            border-bottom: 2px solid var(--pokedex-dark-red);
            flex-shrink: 0;
            z-index: 10;
        }

        .lens-cluster {
            display: flex;
            align-items: flex-start;
        }

        /* The Big Blue Lens */
        .camera-lens {
            width: 60px;
            height: 60px;
            background: radial-gradient(circle at 30% 30%, #4facff, var(--led-blue), #001f5c);
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
            margin-right: 15px;
            position: relative;
            flex-shrink: 0;
        }

        .camera-lens::after {
            content: '';
            position: absolute;
            top: 10px;
            left: 10px;
            width: 15px;
            height: 15px;
            background: white;
            border-radius: 50%;
            opacity: 0.6;
        }

        .mini-leds {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }

        .mini-led {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 1px solid rgba(0, 0, 0, 0.2);
            box-shadow: inset 1px 1px 2px rgba(255, 255, 255, 0.3);
        }

        .led-red {
            background: #FF0000;
        }

        .led-yellow {
            background: #FFFF00;
        }

        .led-green {
            background: #00FF00;
        }

        /* Top Right Buttons Group */
        .top-controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .action-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .action-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 2px solid #222;
            box-shadow: inset -2px -2px 6px rgba(0, 0, 0, 0.4), 2px 2px 0 rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: #fff;
            text-shadow: 1px 1px 0 #000;
            margin-bottom: 2px;
        }

        .action-btn:active {
            transform: scale(0.95);
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.6);
        }

        .btn-blue {
            background-color: var(--btn-blue);
        }

        .btn-orange {
            background-color: #FFA500;
        }

        .btn-label {
            font-size: 0.5rem;
            color: #333;
            /* Dark text on red bg */
            font-weight: bold;
            font-family: 'Press Start 2P', cursive;
            text-transform: uppercase;
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* --- Main Screen Area (Maximized) --- */
        .screen-container {
            flex: 1;
            background-color: #DEDEDE;
            margin: var(--case-padding);
            padding: 20px 35px;
            /* Side padding for arrows */
            border-radius: 8px 8px 30px 8px;
            display: flex;
            flex-direction: column;
            box-shadow: inset 2px 2px 5px rgba(0, 0, 0, 0.2);
            position: relative;
            overflow: hidden;
        }

        /* Arrow Navigation */
        .nav-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 30px;
            height: 60px;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            color: #555;
            /* Inactive color */
            font-size: 1.2rem;
            cursor: pointer;
            z-index: 20;
            border: 2px solid #555;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.3);
        }

        .nav-arrow:active {
            background-color: #222;
            border-color: #000;
            color: var(--btn-yellow);
        }

        .arrow-left {
            left: 0;
            border-radius: 0 10px 10px 0;
            border-left: none;
        }

        .arrow-right {
            right: 0;
            border-radius: 10px 0 0 10px;
            border-right: none;
        }

        /* Triangle Icon */
        .triangle {
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
        }

        .tri-left {
            border-right: 12px solid #888;
        }

        .tri-right {
            border-left: 12px solid #888;
        }

        .nav-arrow:active .tri-left {
            border-right-color: var(--btn-yellow);
        }

        .nav-arrow:active .tri-right {
            border-left-color: var(--btn-yellow);
        }


        /* Inner Display (Black Screen) */
        .main-display {
            flex: 1;
            background-color: var(--screen-bg);
            border-radius: 4px;
            border: 2px solid #555;
            display: flex;
            flex-direction: column;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.8);
            position: relative;
            overflow: hidden;
        }

        /* Scanline effect */
        .main-display::before {
            content: " ";
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px;
            z-index: 5;
            pointer-events: none;
        }

        /* Layout within Black Screen */
        .fixed-screen-top {
            flex-shrink: 0;
            padding: 10px 10px 0 10px;
            background-color: var(--screen-bg);
            z-index: 2;
            border-bottom: 2px solid #444;
        }

        .scroll-screen-bottom {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            scrollbar-width: thin;
            scrollbar-color: #555 var(--screen-bg);
        }

        .scroll-screen-bottom::-webkit-scrollbar {
            width: 6px;
        }

        .scroll-screen-bottom::-webkit-scrollbar-track {
            background: var(--screen-bg);
        }

        .scroll-screen-bottom::-webkit-scrollbar-thumb {
            background: #555;
            border-radius: 3px;
        }

        /* --- Content Styling --- */
        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 5px;
            margin-bottom: 5px;
            font-size: 0.8rem;
        }

        .city-name-display {
            font-family: 'Press Start 2P', cursive;
            color: #FFF;
            font-size: 1.1rem;
            text-shadow: 2px 2px 0 #000;
        }

        .clock-display {
            color: var(--btn-green);
            font-weight: bold;
            font-family: 'Press Start 2P', cursive;
            font-size: 0.6rem;
        }

        .info-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid #444;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 15px;
        }

        .info-title {
            color: var(--btn-yellow);
            font-size: 0.8rem;
            margin-bottom: 8px;
            border-bottom: 1px dashed #555;
            padding-bottom: 4px;
            text-transform: uppercase;
        }

        .hero-temp {
            font-size: 2.2rem;
            font-weight: bold;
            color: #FFF;
        }

        .temp-diff-val {
            font-size: 1.5rem;
            font-weight: bold;
            text-shadow: 1px 1px 0 #000;
        }

        .advice-box {
            background: rgba(81, 174, 95, 0.2);
            border-left: 3px solid var(--btn-green);
            padding: 8px;
            margin-top: 5px;
            font-size: 0.8rem;
            line-height: 1.5;
            color: #ddd;
        }

        /* Loading / Error Overlays */
        .screen-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--btn-green);
            z-index: 50;
            display: none;
        }

        /* Vent decoration (Bottom of case) */
        .vent-deco {
            display: flex;
            justify-content: space-between;
            margin-top: auto;
            padding: 0 25px 15px 25px;
        }
    </style>
</head>

<body>
    <div class="pokedex-case">
        <!-- Top Sensor Bar & Controls -->
        <div class="top-bar">
            <!-- Left: Lens & LEDs -->
            <div class="lens-cluster">
                <div class="camera-lens"></div>
                <!-- Small LEDs -->
                <div class="mini-leds">
                    <div class="mini-led led-red"></div>
                    <div class="mini-led led-yellow"></div>
                    <div class="mini-led led-green"></div>
                </div>
            </div>

            <!-- Right: Action Buttons -->
            <div class="top-controls">
                <!-- LANG -->
                <div class="action-group" onclick="toggleLang()">
                    <div class="action-btn btn-orange">üåç</div>
                    <div class="btn-label" id="btnLabelLang">LANG</div>
                </div>
                <!-- LOCATE -->
                <div class="action-group" onclick="geoFindMe()">
                    <div class="action-btn btn-blue">üìç</div>
                    <div class="btn-label" id="btnLabelLocate">LOCATE</div>
                </div>
            </div>
        </div>

        <!-- Main Screen -->
        <div class="screen-container">

            <!-- Side Navigation Arrows (On the bezel) -->
            <div class="nav-arrow arrow-left" onclick="prevCity()">
                <div class="triangle tri-left"></div>
            </div>
            <div class="nav-arrow arrow-right" onclick="nextCity()">
                <div class="triangle tri-right"></div>
            </div>

            <!-- Black Display -->
            <div class="main-display">

                <div class="screen-loading" id="loadingOverlay">
                    <div style="text-align:center;">
                        <div id="loadingText">CONNECTING...</div>
                        <div style="font-size:2rem; margin-top:10px;">üì∂</div>
                    </div>
                </div>

                <!-- Fixed Top: Location & Time & Hero Weather -->
                <div class="fixed-screen-top">
                    <div class="status-header">
                        <div class="city-name-display" id="cityDisplay">Start...</div>
                        <div class="clock-display" id="clockDisplay">00:00:00</div>
                    </div>
                    <!-- Hero Weather -->
                    <div id="heroCard" class="info-card"
                        style="text-align:center; margin-bottom: 5px; border:none; background:transparent;">
                        <div style="color:#aaa;">WAITING...</div>
                    </div>
                </div>

                <!-- Scrollable Bottom: Details -->
                <div class="scroll-screen-bottom" id="contentArea">
                    <!-- Health / Temp Diff -->
                    <div class="info-card">
                        <div class="info-title" id="lblTempDiff">üå°Ô∏è TEMP DIFF</div>
                        <div id="tempDiffContent">--</div>
                    </div>

                    <!-- Astronomy -->
                    <div class="info-card">
                        <div class="info-title" id="lblAstro">üåô ASTRO</div>
                        <div id="astroContent">--</div>
                    </div>

                    <!-- Forecast -->
                    <div class="info-card">
                        <div class="info-title" id="lblForecast">üìÖ FORECAST</div>
                        <div id="futureForecasts" style="display:flex; overflow-x:auto; gap:10px; padding-bottom:5px;">
                            <!-- items -->
                        </div>
                    </div>

                    <div style="height: 20px;"></div>
                </div>
            </div> <!-- End main-display -->
        </div> <!-- End screen-container -->

        <!-- Bottom Vent Decoration (Visual Balance) -->
        <div class="vent-deco">
            <div
                style="width:30px; height:30px; background:#222; border-radius:50%; border:2px solid #5d0000; box-shadow: inset 2px 2px 5px #000;">
            </div>
            <div style="display:flex; gap:10px; align-items:flex-end;">
                <div style="width:50px; height:8px; background:#5d0000; border-radius:4px;"></div>
                <div style="width:50px; height:8px; background:#5d0000; border-radius:4px;"></div>
            </div>
        </div>

    </div>

    <script>
        const BASE_URL = "https://vibecoding-camp-task4-backend.zeabur.app";
        let CITIES_MAP = {};
        let CITY_KEYS = [];
        let currentIndex = 0;
        let currentLang = 'zh'; // 'zh' or 'en'
        let currentHealthData = null; // Store for lang switch re-render

        const TRANSLATIONS = {
            zh: {
                tempDiff: "üå°Ô∏è Ê∫´Â∑ÆÊèêÈÜí",
                astro: "üåô Â§©ÊñáË≥áË®ä",
                forecast: "üìÖ Â§©Ê∞£È†êÂ†±",
                sun: "Êó•Âá∫",
                moon: "ÊúàÂá∫",
                loading: "ÈÄ£Á∑ö‰∏≠...",
                waiting: "Á≠âÂæÖË≥áÊñô...",
                error: "Ë≥áÊñôÈåØË™§",
                locateErr: "ÁÑ°Ê≥ïÂÆö‰Ωç",
                safe: "Êö´ÁÑ°Ë≠¶Â†±",
                mor: "Êó©", aft: "Âçà", eve: "Êôö",
                // Buttons
                btnLang: "Ë™ûË®Ä",
                btnLocate: "ÂÆö‰Ωç"
            },
            en: {
                tempDiff: "üå°Ô∏è TEMP DIFF",
                astro: "üåô ASTRO",
                forecast: "üìÖ FORECAST",
                sun: "SUN",
                moon: "MOON",
                loading: "CONNECTING...",
                waiting: "WAITING...",
                error: "DATA ERROR",
                locateErr: "LOCATE ERR",
                safe: "SAFE",
                mor: "MOR", aft: "AFT", eve: "EVE",
                // Buttons
                btnLang: "LANG",
                btnLocate: "LOCATE"
            }
        };

        const CITY_COORDS = {
            "taipei": { lat: 25.03, lon: 121.56 },
            "newtaipei": { lat: 25.01, lon: 121.46 },
            "keelung": { lat: 25.12, lon: 121.74 },
            "taoyuan": { lat: 24.99, lon: 121.30 },
            "hsinchu_city": { lat: 24.81, lon: 120.96 },
            "hsinchu_county": { lat: 24.83, lon: 121.01 },
            "miaoli": { lat: 24.56, lon: 120.82 },
            "taichung": { lat: 24.14, lon: 120.68 },
            "changhua": { lat: 24.05, lon: 120.51 },
            "nantou": { lat: 23.96, lon: 120.97 },
            "yunlin": { lat: 23.70, lon: 120.43 },
            "chiayi_city": { lat: 23.48, lon: 120.44 },
            "chiayi_county": { lat: 23.45, lon: 120.25 },
            "tainan": { lat: 22.99, lon: 120.21 },
            "kaohsiung": { lat: 22.62, lon: 120.30 },
            "pingtung": { lat: 22.55, lon: 120.54 },
            "yilan": { lat: 24.70, lon: 121.72 },
            "hualien": { lat: 23.98, lon: 121.60 },
            "taitung": { lat: 22.76, lon: 121.14 },
            "penghu": { lat: 23.57, lon: 119.57 },
            "kinmen": { lat: 24.44, lon: 118.32 },
            "lienchiang": { lat: 26.15, lon: 119.92 }
        };

        // --- Core Logic ---

        async function init() {
            startClock();
            updateUILatels();
            try {
                const res = await fetch(BASE_URL + "/");
                const data = await res.json();
                if (data.cities) {
                    CITIES_MAP = data.cities;
                    CITY_KEYS = Object.keys(data.cities);
                    // Default to Kaohsiung or 0
                    const kIndex = CITY_KEYS.indexOf('kaohsiung');
                    currentIndex = kIndex >= 0 ? kIndex : 0;
                    changeCity(CITY_KEYS[currentIndex]);
                }
            } catch (e) {
                console.error("Init failed", e);
                document.getElementById('cityDisplay').innerText = "ERR";
            }
        }

        function startClock() {
            function update() {
                const now = new Date();
                document.getElementById('clockDisplay').innerText = now.toLocaleTimeString('en-US', { hour12: false });
            }
            setInterval(update, 1000);
            update();
        }

        function toggleLang() {
            currentLang = currentLang === 'zh' ? 'en' : 'zh';
            updateUILatels();

            // Refresh Header City Name using current key
            const cityKey = CITY_KEYS[currentIndex];
            if (cityKey) {
                const name = currentLang === 'zh' ? (CITIES_MAP[cityKey] || cityKey) : cityKey.toUpperCase();
                document.getElementById('cityDisplay').innerText = name;
            }

            // Re-render Health Advice if exists
            if (currentHealthData) {
                renderHealth(currentHealthData);
            }
        }

        function updateUILatels() {
            const t = TRANSLATIONS[currentLang];
            document.getElementById('lblTempDiff').innerText = t.tempDiff;
            document.getElementById('lblAstro').innerText = t.astro;
            document.getElementById('lblForecast').innerText = t.forecast;
            document.getElementById('loadingText').innerText = t.loading;

            // Button Labels
            document.getElementById('btnLabelLang').innerText = t.btnLang;
            document.getElementById('btnLabelLocate').innerText = t.btnLocate;
        }

        async function changeCity(cityKey) {
            const loading = document.getElementById('loadingOverlay');
            loading.style.display = 'flex';

            // Update Header Name
            const name = currentLang === 'zh' ? (CITIES_MAP[cityKey] || cityKey) : cityKey.toUpperCase();
            document.getElementById('cityDisplay').innerText = name;

            try {
                const pWeather = fetch(BASE_URL + "/api/weather/" + cityKey).then(r => r.json());
                const pHealth = fetch(BASE_URL + "/api/health/temp-difference/" + cityKey).then(r => r.json());
                const pSun = fetch(BASE_URL + "/api/astronomy/sun/" + cityKey).then(r => r.json());
                const pMoon = fetch(BASE_URL + "/api/astronomy/moon/" + cityKey).then(r => r.json());

                await new Promise(r => setTimeout(r, 400)); // Slight delay

                const [weatherData, healthData, sunData, moonData] = await Promise.all([
                    pWeather, pHealth, pSun, pMoon
                ]);

                if (weatherData.success) {
                    renderWeather(weatherData.data);

                    // Store health data global for language toggle
                    currentHealthData = healthData.data;
                    renderHealth(healthData.data);

                    renderAstronomy(sunData.data, moonData.data);
                }
            } catch (e) {
                console.error(e);
            } finally {
                loading.style.display = 'none';
            }
        }

        function nextCity() {
            if (CITY_KEYS.length === 0) return;
            currentIndex = (currentIndex + 1) % CITY_KEYS.length;
            changeCity(CITY_KEYS[currentIndex]);
        }

        function prevCity() {
            if (CITY_KEYS.length === 0) return;
            currentIndex = (currentIndex - 1 + CITY_KEYS.length) % CITY_KEYS.length;
            changeCity(CITY_KEYS[currentIndex]);
        }

        // --- Swipe ---
        let touchstartX = 0;
        let touchendX = 0;
        const screenDiv = document.querySelector('.screen-container');

        screenDiv.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; });
        screenDiv.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            if (touchendX < touchstartX - 50) nextCity();
            if (touchendX > touchstartX + 50) prevCity();
        });

        // --- Rendering ---
        function getWeatherIcon(weather) {
            if (!weather) return "üå§Ô∏è";
            const w = weather;
            // Simple mapping
            if (w.includes("Êô¥")) return "‚òÄÔ∏è";
            if (w.includes("Èõ≤") || w.includes("Èô∞")) return "‚òÅÔ∏è";
            if (w.includes("Èõ®")) return "üåßÔ∏è";
            if (w.includes("Èõ∑")) return "‚õàÔ∏è";
            return "üå§Ô∏è";
        }

        function renderWeather(data) {
            const current = data.forecasts[0];
            const others = data.forecasts.slice(1);
            const avgTemp = Math.round((parseInt(current.maxTemp) + parseInt(current.minTemp)) / 2);

            document.getElementById('heroCard').innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:3rem;">${getWeatherIcon(current.weather)}</div>
                    <div style="text-align:right;">
                        <div class="hero-temp">${avgTemp}¬∞C</div>
                        <div style="color:var(--btn-yellow); font-size:0.8rem;">${current.weather}</div>
                    </div>
                </div>
                <div style="margin-top:5px; display:flex; justify-content:space-around; font-size:0.7rem; color:#aaa;">
                    <div>üåßÔ∏è ${current.rain}</div>
                    <div>üå°Ô∏è ${current.minTemp} ~ ${current.maxTemp}</div>
                </div>
            `;

            const scrollContainer = document.getElementById('futureForecasts');
            scrollContainer.innerHTML = '';
            const t = TRANSLATIONS[currentLang];

            others.forEach(f => {
                const hour = new Date(f.startTime).getHours();
                const p = hour < 12 ? t.mor : (hour < 18 ? t.aft : t.eve);
                scrollContainer.innerHTML += `
                    <div style="min-width:60px; text-align:center; background:rgba(0,0,0,0.2); padding:5px; border-radius:4px;">
                        <div style="font-size:0.6rem; color:#888;">${p}</div>
                        <div style="font-size:1.2rem;">${getWeatherIcon(f.weather)}</div>
                        <div style="font-size:0.7rem;">${parseInt(f.minTemp)}¬∞</div>
                    </div>
                `;
            });
        }

        function renderHealth(data) {
            const div = document.getElementById('tempDiffContent');
            const t = TRANSLATIONS[currentLang];

            if (!data || data.tempDiffIndex === undefined) {
                div.innerHTML = "<small>NO DATA</small>";
                return;
            }

            const val = data.tempDiffIndex;
            const warning = data.tempDiffWarning || t.safe;

            // Handle advice object {zh, en} or string
            let adviceText = "";
            if (typeof data.clothingAdvice === 'object') {
                adviceText = data.clothingAdvice[currentLang] || data.clothingAdvice.zh;
            } else {
                adviceText = data.clothingAdvice;
            }

            const color = val >= 10 ? '#ff4d4d' : (val >= 6 ? '#FFAA5E' : '#7DE1A9');

            div.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                    <div class="temp-diff-val" style="color:${color}">${val}</div>
                    <div style="font-size:0.8rem; color:${data.tempDiffWarning ? '#ff4d4d' : '#888'};">${warning}</div>
                </div>
                <div class="advice-box">
                    üß• ${adviceText}
                </div>
            `;
        }

        function renderAstronomy(sunData, moonData) {
            const div = document.getElementById('astroContent');
            const t = TRANSLATIONS[currentLang];
            try {
                const now = new Date();
                const offset = now.getTimezoneOffset() * 60000;
                const today = new Date(now - offset).toISOString().split('T')[0];

                const getInfo = (data) => {
                    if (!data || !data.locations || !data.locations.location) return null;
                    const loc = data.locations.location[0];
                    if (!loc || !loc.time) return null;
                    return loc.time.find(t => t.Date === today) || loc.time[0];
                };

                const sunLoc = getInfo(sunData);
                const moonLoc = getInfo(moonData);

                let html = '<div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">';
                if (sunLoc) {
                    html += `
                    <div>
                        <div style="color:var(--btn-yellow); font-size:0.7rem;">${t.sun}</div>
                        <div>üåû ${sunLoc.SunRiseTime || '--'}</div>
                        <div>üåö ${sunLoc.SunSetTime || '--'}</div>
                    </div>`;
                }
                if (moonLoc) {
                    html += `
                    <div>
                        <div style="color:#aaa; font-size:0.7rem;">${t.moon}</div>
                        <div>üåõ ${moonLoc.MoonRiseTime || '--'}</div>
                    </div>`;
                }
                html += '</div>';
                div.innerHTML = html;
            } catch (e) {
                div.innerHTML = "<small>DATA ERROR</small>";
            }
        }

        function geoFindMe() {
            if (!navigator.geolocation) {
                alert("Geo Not Supported");
                return;
            }
            const loading = document.getElementById('loadingOverlay');
            loading.style.display = 'flex';

            navigator.geolocation.getCurrentPosition(success, error);

            function success(position) {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                let minDist = Infinity;
                let nearestKey = 'taipei';

                for (const [key, coords] of Object.entries(CITY_COORDS)) {
                    const d = Math.sqrt(Math.pow(lat - coords.lat, 2) + Math.pow(lon - coords.lon, 2));
                    if (d < minDist) {
                        minDist = d;
                        nearestKey = key;
                    }
                }

                const newIndex = CITY_KEYS.indexOf(nearestKey);
                if (newIndex >= 0) {
                    currentIndex = newIndex;
                    changeCity(nearestKey);
                } else {
                    loading.style.display = 'none';
                }
            }

            function error() {
                loading.style.display = 'none';
                alert(TRANSLATIONS[currentLang].locateErr);
            }
        }

        document.addEventListener("DOMContentLoaded", init);
    </script>
</body>

</html>